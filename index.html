<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa de Cobertura - E-MÍDIAS</title>
    
    <!-- 
    ============================================================================
    🎨 IDENTIDADE VISUAL E-MÍDIAS APLICADA
    ============================================================================
    ✅ NOVO: Suporte a Múltiplas Rádios (Modo Proposta)
    1. Detecta ?proposta=DATABASE_ID vs ?id=RADIO_ID
    2. Múltiplas rádios no mesmo mapa
    3. Stats agregadas (universo total, PMM total)
    4. Lista unificada de cidades
    5. Mantém compatibilidade com modo individual
    
    🎨 PALETA DE CORES E-MÍDIAS:
    - Azul Escuro: #06055B (principal)
    - Magenta: #FC1E75 (destaque)  
    - Rosa Claro: #D71E97 (secundário)
    - Roxo: #AA1EA5 (accent)
    - Roxo Acinzentado: #9E33AC
    ============================================================================
    -->
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Google Fonts - E-MÍDIAS Typography -->
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* =============================================================================
           🎨 IDENTIDADE VISUAL E-MÍDIAS
           ============================================================================= */
        
        :root {
            /* 🎨 Paleta de Cores E-MÍDIAS (baseada no manual oficial) */
            --emidias-primary: #06055B;         /* Azul Escuro - Principal */
            --emidias-magenta: #FC1E75;         /* Magenta - Destaque */
            --emidias-rosa: #D71E97;            /* Rosa Claro - Secundário */
            --emidias-roxo: #AA1EA5;            /* Roxo - Accent */
            --emidias-roxo-cinza: #9E33AC;      /* Roxo Acinzentado */
            --emidias-success: #10B981;         /* Verde sucesso */
            --emidias-gray: #64748B;            /* Cinza texto */
            --emidias-light-gray: #F1F5F9;      /* Cinza claro */
            --emidias-white: #FFFFFF;           /* Branco */
            --emidias-dark: #1E293B;            /* Escuro */
            
            /* 🎨 Gradientes E-MÍDIAS */
            --gradient-primary: linear-gradient(135deg, var(--emidias-primary) 0%, var(--emidias-roxo) 100%);
            --gradient-accent: linear-gradient(135deg, var(--emidias-magenta) 0%, var(--emidias-rosa) 100%);
            --gradient-success: linear-gradient(135deg, var(--emidias-success) 0%, #34D399 100%);
            
            /* 📝 Tipografia E-MÍDIAS */
            --font-primary: 'Space Grotesk', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            --font-weight-light: 300;
            --font-weight-normal: 400;
            --font-weight-medium: 500;
            --font-weight-semibold: 600;
            --font-weight-bold: 700;
            
            /* 🎨 Sombras E-MÍDIAS */
            --shadow-sm: 0 1px 3px rgba(6, 5, 91, 0.05);
            --shadow-md: 0 4px 12px rgba(6, 5, 91, 0.1);
            --shadow-lg: 0 8px 25px rgba(6, 5, 91, 0.15);
            --shadow-accent: 0 4px 15px rgba(252, 30, 117, 0.2);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: var(--font-primary);
            background: var(--emidias-white);
            color: var(--emidias-dark);
            line-height: 1.6;
            font-weight: var(--font-weight-normal);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* =============================================================================
           🎨 HEADER COM IDENTIDADE E-MÍDIAS
           ============================================================================= */
        .header {
            background: var(--emidias-white);
            color: var(--emidias-primary);
            padding: 32px 24px;
            border-radius: 16px;
            margin-bottom: 16px;
            box-shadow: var(--shadow-lg);
            text-align: center;
            position: relative;
            overflow: hidden;
            border: 2px solid var(--emidias-primary);
        }
        
        /* Efeito de brilho sutil */
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(6, 5, 91, 0.05), transparent);
            animation: shine 4s infinite;
        }
        
        @keyframes shine {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        .header-title {
            font-size: 28px;
            font-weight: var(--font-weight-bold);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0px;
            position: relative;
            z-index: 1;
            flex-direction: column;
        }
        
        .header-logo {
            width: 150px;
            height: 120px;
            object-fit: contain;
            border-radius: 12px;
            box-shadow: var(--shadow-md);
            transition: transform 0.3s ease;
            margin-bottom: 16px;
        }
        
        .header-logo:hover {
            transform: scale(1.05);
        }
        
        .header-subtitle {
            font-size: 16px;
            opacity: 0.8;
            font-weight: var(--font-weight-medium);
            position: relative;
            z-index: 1;
            color: var(--emidias-gray);
        }
        
        /* =============================================================================
           🎨 HEADER COM LOGO E-MÍDIAS INTEGRADA
           ============================================================================= */
        .header-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            position: relative;
            z-index: 1;
        }
        
        .header-main {
            flex: 1;
            text-align: center;
        }
        
        /* =============================================================================
           🏢 MARCA D'ÁGUA E-MÍDIAS INSTITUCIONAL
           ============================================================================= */
        .brand-watermark {
            position: fixed;
            top: 20px;
            right: 20px;
            height: 120px;
            width: auto;
            opacity: 0.15;
            pointer-events: none;
            z-index: 999;
            transition: opacity 0.3s ease;
        }
        
        .brand-watermark:hover {
            opacity: 0.3;
        }
        
        /* =============================================================================
           🎯 INDICADOR DE TIPO (INDIVIDUAL VS PROPOSTA)
           ============================================================================= */
        .type-indicator {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: var(--font-weight-bold);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-left: 12px;
        }
        
        .type-individual {
            background: var(--gradient-success);
            color: var(--emidias-white);
        }
        
        .type-proposta {
            background: var(--gradient-accent);
            color: var(--emidias-white);
        }
        
        /* =============================================================================
           📋 CARDS DE INFORMAÇÃO E-MÍDIAS (COMPACTOS + PROPOSTA)
           ============================================================================= */
        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 20px;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
        }
        
        /* Grid especial para proposta (3 colunas no desktop) */
        .info-grid.proposta {
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .info-card {
            background: var(--emidias-white);
            padding: 16px;
            border-radius: 12px;
            box-shadow: var(--shadow-md);
            border-left: 4px solid var(--emidias-primary);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .info-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--gradient-primary);
        }
        
        .info-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-left-color: var(--emidias-magenta);
        }
        
        .info-card:hover::before {
            background: var(--gradient-accent);
        }
        
        .card-title {
            font-size: 18px;
            font-weight: var(--font-weight-bold);
            color: var(--emidias-primary);
            margin-bottom: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--emidias-light-gray);
            transition: all 0.2s ease;
        }
        
        .info-item:last-child {
            border-bottom: none;
        }
        
        .info-item:hover {
            background: rgba(6, 5, 91, 0.02);
            border-radius: 8px;
            padding-left: 8px;
            padding-right: 8px;
        }
        
        .info-label {
            font-weight: var(--font-weight-semibold);
            color: var(--emidias-gray);
        }
        
        .info-value {
            font-weight: var(--font-weight-medium);
            color: var(--emidias-dark);
        }
        
        .info-value.highlight {
            background: var(--gradient-primary);
            color: var(--emidias-white);
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 14px;
        }
        
        /* =============================================================================
           📊 LISTA DE RÁDIOS NA PROPOSTA
           ============================================================================= */
        .radios-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--emidias-light-gray);
            border-radius: 8px;
            background: rgba(6, 5, 91, 0.01);
        }
        
        .radio-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            border-bottom: 1px solid var(--emidias-light-gray);
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .radio-item:hover {
            background: rgba(6, 5, 91, 0.05);
            transform: translateX(4px);
        }
        
        .radio-item:last-child {
            border-bottom: none;
        }
        
        .radio-item img {
            width: 36px;
            height: 27px;
            border-radius: 4px;
            margin-right: 8px;
            object-fit: cover;
        }
        
        .radio-item-info {
            flex: 1;
        }
        
        .radio-item-name {
            font-weight: var(--font-weight-semibold);
            font-size: 14px;
            color: var(--emidias-dark);
        }
        
        .radio-item-details {
            font-size: 12px;
            color: var(--emidias-gray);
        }
        
        .radio-item-checkbox {
            margin-left: 12px;
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--emidias-primary);
        }
        
        .radio-item.disabled {
            opacity: 0.5;
            background: rgba(0, 0, 0, 0.02);
        }
        
        .radio-count-badge {
            position: absolute;
            top: 12px;
            right: 16px;
            background: var(--gradient-accent);
            color: var(--emidias-white);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: var(--font-weight-bold);
            min-width: 24px;
            text-align: center;
        }
        
        /* =============================================================================
           🗺️ MAPA CONTAINER E-MÍDIAS
           ============================================================================= */
        .map-container {
            background: var(--emidias-white);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--shadow-lg);
            margin-bottom: 24px;
            transition: all 0.3s ease;
            border: 1px solid var(--emidias-light-gray);
        }
        
        .map-container:hover {
            box-shadow: 0 12px 35px rgba(6, 5, 91, 0.2);
            transform: translateY(-2px);
        }
        
        #map {
            height: 550px;
            width: 100%;
            min-height: 550px;
            transition: filter 0.3s ease;
        }
        
        /* =============================================================================
           🌍 SEÇÃO CIDADES E-MÍDIAS
           ============================================================================= */
        .cidades-container {
            background: var(--emidias-white);
            border-radius: 16px;
            padding: 28px;
            box-shadow: var(--shadow-md);
            border-left: 4px solid var(--emidias-primary);
            position: relative;
            overflow: hidden; /* ✅ FIX: Corrigido para não cortar tooltips mas evitar scroll */
        }
        
        .cidades-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--gradient-primary);
        }
        
        .cidades-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 16px;
        }
        
        .cidades-title {
            font-size: 22px;
            font-weight: var(--font-weight-bold);
            color: var(--emidias-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .cidade-count {
            background: var(--gradient-accent);
            color: var(--emidias-white);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: var(--font-weight-bold);
        }
        
        .cidades-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .excel-export-btn {
            background: var(--gradient-success);
            color: var(--emidias-white);
            border: none;
            padding: 10px 20px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: var(--font-weight-semibold);
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-sm);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .excel-export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.3);
        }
        
        .excel-export-btn:active {
            transform: translateY(0);
        }
        
        .search-box {
            margin-bottom: 20px;
        }
        
        .search-input {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid var(--emidias-light-gray);
            border-radius: 12px;
            font-size: 16px;
            font-family: var(--font-primary);
            font-weight: var(--font-weight-normal);
            transition: all 0.3s ease;
            background: var(--emidias-white);
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--emidias-primary);
            box-shadow: 0 0 0 4px rgba(6, 5, 91, 0.1);
            background: rgba(6, 5, 91, 0.01);
        }
        
        .cidades-list {
            max-height: 350px;
            overflow-y: auto;
            border: 1px solid var(--emidias-light-gray);
            border-radius: 12px;
            background: var(--emidias-white);
            /* ✅ FIX: Removido overflow-x para evitar scroll horizontal */
        }
        
        .cidade-item {
            padding: 16px 20px;
            border-bottom: 1px solid var(--emidias-light-gray);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
            /* ✅ FIX: Evita quebras de linha que causam scroll horizontal */
            min-width: 0;
            word-wrap: break-word;
        }
        
        .cidade-item:hover {
            background: linear-gradient(90deg, rgba(6, 5, 91, 0.03) 0%, var(--emidias-white) 100%);
            transform: translateX(8px);
            border-left: 4px solid var(--emidias-primary);
            padding-left: 16px;
        }
        
        .cidade-item:last-child {
            border-bottom: none;
        }
        
        .cidade-info {
            flex: 1;
            min-width: 0; /* ✅ FIX: Permite que o texto seja truncado se necessário */
        }
        
        .cidade-name {
            font-weight: var(--font-weight-medium);
            color: var(--emidias-dark);
            font-size: 15px;
        }
        
        .cidade-uf {
            font-size: 13px;
            color: var(--emidias-gray);
            margin-left: 8px;
            font-weight: var(--font-weight-normal);
        }
        
        .cidade-radios {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-left: 16px;
            flex-shrink: 0; /* ✅ FIX: Evita que as rádios sejam comprimidas */
        }
        
        .cidade-radios-container {
            position: relative;
            display: flex;
            align-items: center;
        }
        
        .radios-collapsed {
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
        }
        
        .radios-expanded {
            position: absolute;
            right: 0;
            background: var(--emidias-white);
            border: 2px solid var(--emidias-primary);
            border-radius: 12px;
            padding: 12px;
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            min-width: 280px;
            display: none;
            flex-direction: column;
            gap: 8px;
            animation: slideInLeft 0.2s ease-out;
            /* ✅ FIX: Melhor posicionamento para evitar corte e piscadas */
            top: 50%;
            transform: translateY(-50%);
        }
        
        /* ✅ FIX: Tooltip posicionado acima quando está nos primeiros itens */
        .cidade-item:nth-child(-n+3) .radios-expanded {
            top: 100%;
            transform: translateY(0);
            margin-top: 8px;
        }
        
        /* ✅ FIX: Tooltip posicionado abaixo quando está nos últimos itens */  
        .cidade-item:nth-last-child(-n+3) .radios-expanded {
            top: auto;
            bottom: 100%;
            transform: translateY(0);
            margin-bottom: 8px;
        }
        
        /* ✅ FIX: Posicionamento padrão estabilizado */
        .cidade-radios-container:hover .radios-expanded {
            display: flex !important;
        }
        
        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(20px) translateY(-50%);
            }
            to {
                opacity: 1;
                transform: translateX(0) translateY(-50%);
            }
        }
        
        .radio-logo-mini {
            width: 36px;
            height: 27px;
            border-radius: 6px;
            object-fit: cover;
            border: 2px solid var(--emidias-light-gray);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .radio-logo-mini:hover {
            transform: scale(1.1);
            border-color: var(--emidias-primary);
            box-shadow: var(--shadow-sm);
        }
        
        .radio-count-extra {
            background: var(--emidias-gray);
            color: var(--emidias-white);
            border-radius: 50%;
            width: 30px;
            height: 27px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: var(--font-weight-bold);
        }
        
        .radio-expanded {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 12px;
            background: rgba(6, 5, 91, 0.05);
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .radio-expanded:hover {
            background: rgba(6, 5, 91, 0.08);
            transform: translateX(4px);
        }
        
        .radio-expanded img {
            width: 36px;
            height: 27px;
            border-radius: 6px;
            object-fit: cover;
            border: 1px solid var(--emidias-light-gray);
        }
        
        .radio-expanded-info {
            display: flex;
            flex-direction: column;
            flex: 1;
        }
        
        .radio-expanded-name {
            font-size: 14px;
            font-weight: var(--font-weight-semibold);
            color: var(--emidias-dark);
            line-height: 1.2;
        }
        
        .radio-expanded-details {
            font-size: 12px;
            color: var(--emidias-gray);
            line-height: 1.2;
        }
        
        /* =============================================================================
           ⏳ LOADING E-MÍDIAS
           ============================================================================= */
        .loading {
            text-align: center;
            padding: 60px 20px;
            color: var(--emidias-gray);
        }
        
        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--emidias-light-gray);
            border-top: 4px solid var(--emidias-primary);
            border-radius: 50%;
            animation: spin 1.2s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* =============================================================================
           ❌ ERROR E-MÍDIAS
           ============================================================================= */
        .error {
            background: linear-gradient(135deg, #FEF2F2 0%, #FFFFFF 100%);
            border: 1px solid #FECACA;
            color: var(--emidias-magenta);
            padding: 24px;
            border-radius: 12px;
            text-align: center;
            margin: 24px 0;
            box-shadow: var(--shadow-sm);
        }
        
        .error-details {
            margin-top: 16px;
            font-size: 12px;
            color: #991B1B;
            font-family: 'Courier New', monospace;
            background: rgba(255, 255, 255, 0.8);
            padding: 12px;
            border-radius: 8px;
            text-align: left;
        }
        
        /* =============================================================================
           🦶 RODAPÉ E-MÍDIAS
           ============================================================================= */
        .footer {
            text-align: center;
            padding: 40px 20px;
            margin-top: 40px;
            border-top: 2px solid var(--emidias-light-gray);
            background: linear-gradient(135deg, #FAFBFC 0%, var(--emidias-white) 100%);
            border-radius: 16px 16px 0 0;
        }
        
        .footer-logo {
            width: 160px;
            height: auto;
            opacity: 0.8;
            margin-bottom: 12px;
            transition: all 0.3s ease;
            filter: grayscale(20%);
        }
        
        .footer-logo:hover {
            opacity: 1;
            transform: scale(1.05);
            filter: grayscale(0%);
        }
        
        .footer-text {
            font-size: 14px;
            color: var(--emidias-gray);
            margin: 0;
            font-weight: var(--font-weight-medium);
        }
        
        /* =============================================================================
           📱 RESPONSIVIDADE E-MÍDIAS
           ============================================================================= */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 16px;
            }
            
            .info-grid { 
                grid-template-columns: 1fr; 
                gap: 14px;
                max-width: 100%;
            }
            
            .info-grid.proposta {
                grid-template-columns: 1fr;
            }
            
            .header-logo { 
                width: 100px;
                height: 80px; 
                margin-bottom: 12px;
            }
            
            .header-title { 
                font-size: 20px; 
            }
            
            .container { 
                padding: 16px; 
            }
            
            #map { 
                height: 450px; 
                min-height: 450px; 
            }
            
            .header {
                padding: 24px 20px;
                margin-bottom: 20px;
            }
            
            .cidades-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .cidades-actions {
                justify-content: center;
            }
            
            .search-input {
                padding: 14px 16px;
                font-size: 16px;
            }
            
            .brand-watermark {
                height: 80px;
                top: 10px;
                right: 10px;
            }
            
            .type-indicator {
                margin-left: 0;
                margin-top: 8px;
                display: block;
            }
            
            .radios-expanded {
                min-width: 240px;
                font-size: 12px;
            }
        }
        
        @media (max-width: 480px) {
            .header-title {
                font-size: 18px;
            }
            
            .header-logo { 
                width: 80px;
                height: 60px; 
                margin-bottom: 8px;
            }
            
            .info-card {
                padding: 12px;
            }
            
            .cidades-container {
                padding: 20px;
            }
            
            .excel-export-btn {
                padding: 8px 16px;
                font-size: 13px;
            }
            
            .brand-watermark {
                height: 60px;
            }
            
            .radios-expanded {
                min-width: 200px;
                font-size: 11px;
            }
        }
        
        /* =============================================================================
           🗺️ CUSTOMIZAÇÕES LEAFLET E-MÍDIAS
           ============================================================================= */
        .leaflet-popup-content-wrapper {
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
        }
        
        .leaflet-popup-tip {
            box-shadow: var(--shadow-sm);
        }
        
        .radio-popup {
            text-align: center;
            min-width: 220px;
            font-family: var(--font-primary);
        }
        
        .radio-popup img {
            width: 90px;
            height: 68px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-sm);
        }
        
        .radio-popup h3 {
            margin: 0 0 8px 0;
            color: var(--emidias-primary);
            font-size: 18px;
            font-weight: var(--font-weight-bold);
        }
        
        .radio-popup p {
            margin: 6px 0;
            font-size: 14px;
            color: var(--emidias-gray);
            font-weight: var(--font-weight-medium);
        }
        
        /* Marcadores customizados */
        .city-marker,
        .radio-marker,
        .temp-city-marker {
            background: transparent !important;
            border: none !important;
        }
        
        .radio-marker-image {
            width: 56px !important;
            height: 56px !important;
            border-radius: 50%;
            border: 3px solid var(--emidias-white);
            box-shadow: var(--shadow-md);
            object-fit: cover;
            transition: all 0.3s ease;
        }
        
        .radio-marker-image:hover {
            transform: scale(1.1);
            box-shadow: var(--shadow-lg);
        }
        
        /* Marcadores específicos para proposta (cores diferentes) */
        .radio-marker-image.proposta-1 {
            border-color: var(--emidias-primary);
        }
        
        .radio-marker-image.proposta-2 {
            border-color: var(--emidias-magenta);
        }
        
        .radio-marker-image.proposta-3 {
            border-color: var(--emidias-rosa);
        }
        
        .radio-marker-image.proposta-4 {
            border-color: var(--emidias-roxo);
        }
        
        .radio-marker-image.proposta-5 {
            border-color: var(--emidias-success);
        }
        
        /* =============================================================================
           🎨 ANIMAÇÕES E-MÍDIAS
           ============================================================================= */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .info-card,
        .map-container,
        .cidades-container {
            animation: fadeInUp 0.6s ease-out;
        }
        
        .info-card:nth-child(2) {
            animation-delay: 0.1s;
        }
        
        .map-container {
            animation-delay: 0.2s;
        }
        
        .cidades-container {
            animation-delay: 0.3s;
        }
    </style>
</head>
<body>
    <!-- MARCA D'ÁGUA E-MÍDIAS INSTITUCIONAL -->
    <img class="brand-watermark" 
         src="./assets/logo E-MIDIAS png fundo branco.png" 
         alt="E-MÍDIAS" 
         onerror="this.src='./assets/logo E-MIDIAS png fundo branco HORIZONTAL.png'; this.onerror=function(){this.style.display='none'};">
    
    <div class="container">
        <!-- HEADER E-MÍDIAS COM LOGO INTEGRADA -->
        <div class="header">
            <div class="header-content">
                <div class="header-main">
                    <h1 class="header-title" id="radio-name">
                        Carregando...
                        <img class="header-logo" id="header-logo" src="" alt="Logo" style="display: none;">
                    </h1>
                    <div class="header-subtitle">
                        <span id="radio-info"></span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- LOADING -->
        <div id="loading" class="loading">
            <div class="loading-spinner"></div>
            <p>Carregando dados...</p>
        </div>
        
        <!-- ERROR -->
        <div id="error" class="error" style="display: none;">
            <div id="error-message"></div>
            <div id="error-details" class="error-details" style="display: none;"></div>
        </div>
        
        <!-- INFORMAÇÕES -->
        <div id="info-section" class="info-grid" style="display: none;">
            <!-- Cards serão gerados dinamicamente -->
        </div>
        
        <!-- MAPA -->
        <div id="map-section" class="map-container" style="display: none;">
            <div id="map"></div>
        </div>
        
        <!-- CIDADES -->
        <div id="cidades-section" class="cidades-container" style="display: none;">
            <div class="cidades-header">
                <h2 class="cidades-title">
                    🌍 Cidades de Cobertura
                    <span class="cidade-count" id="cidade-count">0</span>
                </h2>
                <div class="cidades-actions">
                    <button 
                        class="excel-export-btn" 
                        onclick="exportToExcel()" 
                        title="Exportar cidades para Excel">
                        📊 Exportar Excel (.xlsx)
                    </button>
                </div>
            </div>
            
            <div class="search-box">
                <input 
                    type="text" 
                    class="search-input" 
                    id="city-search" 
                    placeholder="🔍 Buscar cidade ou região..."
                >
            </div>
            
            <div class="cidades-list" id="cidades-list">
                <!-- Lista será gerada dinamicamente -->
            </div>
        </div>
        
        <!-- RODAPÉ E-MÍDIAS -->
        <div class="footer">
            <p class="footer-text">Plataforma de Mapeamento de Cobertura de Rádios • E-MÍDIAS</p>
        </div>
    </div>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- SheetJS para exportação Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script>
        // =========================================================================
        // 🚀 VARIÁVEIS GLOBAIS E-MÍDIAS
        // =========================================================================
        let map;
        let radioData = {};
        let radioMarkers = []; // Array para múltiplos marcadores
        let coverageLayers = []; // Array para múltiplas coberturas
        let cityMarkers = [];
        let allCities = [];
        let filteredCities = [];
        let isPropostaMode = false; // Flag para detectar modo
        let activeRadios = []; // Array para controlar rádios ativas (checkboxes)
        let cityRadioMapping = {}; // Mapeamento cidade -> rádios que a cobrem
        
        // Mapeamento entre nomes de cidades e índices dos marcadores
        window.cityPlacemarkMap = {};
        
        // Cores para diferentes rádios na proposta
        const RADIO_COLORS = [
            '#06055B', // Azul E-MÍDIAS
            '#FC1E75', // Magenta E-MÍDIAS
            '#D71E97', // Rosa E-MÍDIAS
            '#AA1EA5', // Roxo E-MÍDIAS
            '#10B981', // Verde sucesso
            '#9E33AC'  // Roxo acinzentado
        ];
        
        // =========================================================================
        // 📊 FUNÇÃO EXPORT EXCEL (.XLSX) - E-MÍDIAS (MELHORADA PARA PROPOSTA)
        // =========================================================================
        function exportToExcel() {
            let citiesToExport = [];
            
            if (isPropostaMode) {
                // Modo proposta: usar apenas cidades únicas (sem nomes de rádios)
                citiesToExport = getUniqueCitiesOnly() || [];
            } else {
                // Modo individual: usar radioData.cidades
                citiesToExport = radioData.cidades || [];
            }
            
            if (!citiesToExport || citiesToExport.length === 0) {
                alert('❌ Nenhuma cidade disponível para exportar.');
                return;
            }
            
            try {
                // Preparar dados para Excel
                const excelData = [];
                
                // Cabeçalho
                if (isPropostaMode) {
                    excelData.push(['UF', 'Cidade', 'Rádios']);
                } else {
                    excelData.push(['Cidade', 'UF', 'Região', 'Distância (km)']);
                }
                
                // Dados das cidades
                citiesToExport.forEach(cidadeOriginal => {
                    let nomeCidade = cidadeOriginal;
                    let uf = '';
                    
                    // Separar UF se houver " - UF"
                    if (cidadeOriginal.includes(' - ')) {
                        const parts = cidadeOriginal.split(' - ');
                        nomeCidade = parts[0];
                        uf = parts[1];
                    }
                    
                    if (isPropostaMode) {
                        // Buscar rádios que cobrem esta cidade
                        const radiosQueCobrema = cityRadioMapping[nomeCidade] || [];
                        const radiosTexto = radiosQueCobrema.map(radio => 
                            `${radio.name} ${radio.dial}`
                        ).join(', ');
                        
                        excelData.push([
                            uf,
                            nomeCidade,
                            radiosTexto
                        ]);
                    } else {
                        // Modo individual (lógica original)
                        let distanciaKm = 0;
                        
                        // Extrair distância se houver parênteses
                        if (nomeCidade.includes('(') && nomeCidade.includes('km')) {
                            const regex = /^(.*?)\s*\((\d+\.?\d*)\s*km\)$/;
                            const match = nomeCidade.match(regex);
                            
                            if (match) {
                                nomeCidade = match[1].trim();
                                distanciaKm = parseFloat(match[2]);
                            }
                        }
                        
                        excelData.push([
                            nomeCidade,
                            uf || radioData.uf,
                            radioData.region || 'N/A',
                            distanciaKm
                        ]);
                    }
                });
                
                // Criar workbook usando SheetJS
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(excelData);
                
                // Configurar largura das colunas
                if (isPropostaMode) {
                    ws['!cols'] = [
                        { width: 8 },  // UF
                        { width: 30 }, // Cidade
                        { width: 50 }  // Rádios
                    ];
                } else {
                    ws['!cols'] = [
                        { width: 30 }, // Cidade
                        { width: 8 },  // UF
                        { width: 15 }, // Região
                        { width: 15 }  // Distância (km)
                    ];
                }
                
                // Adicionar worksheet ao workbook
                XLSX.utils.book_append_sheet(wb, ws, "Cobertura");
                
                // Gerar nome do arquivo
                let fileName;
                if (isPropostaMode) {
                    const dateStr = new Date().toISOString().split('T')[0];
                    const activeCount = activeRadios.filter(r => r.active).length;
                    fileName = `cobertura-proposta-${activeCount}radios-${dateStr}.xlsx`;
                } else {
                    const radioName = radioData.name ? radioData.name.replace(/[^a-z0-9]/gi, '_').toLowerCase() : 'radio';
                    fileName = `cobertura-${radioName}-${new Date().toISOString().split('T')[0]}.xlsx`;
                }
                
                // Baixar arquivo Excel
                XLSX.writeFile(wb, fileName);
                
                // Feedback visual
                const btn = document.querySelector('.excel-export-btn');
                if (btn) {
                    const originalText = btn.innerHTML;
                    btn.innerHTML = '✅ Exportado!';
                    btn.style.background = 'var(--gradient-success)';
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.style.background = 'var(--gradient-success)';
                    }, 2000);
                }
                
            } catch (error) {
                console.error('Erro detalhado:', error);
                alert('❌ Erro ao exportar arquivo. Tente novamente.');
            }
        }
        
        // =========================================================================
        // 🏙️ FUNÇÃO PARA OBTER APENAS CIDADES ÚNICAS (SEM NOMES DE RÁDIOS)
        // =========================================================================
        function getUniqueCitiesOnly() {
            const uniqueCities = new Set();
            
            // Coletar cidades de todas as rádios ativas
            activeRadios.forEach((radio, index) => {
                if (radio.active && radioData.radios[index]) {
                    const cities = radioData.radios[index].cidades || [];
                    cities.forEach(cidade => {
                        // Verificar se é realmente uma cidade (não nome de rádio)
                        if (isRealCity(cidade)) {
                            uniqueCities.add(cidade);
                        }
                    });
                }
            });
            
            return Array.from(uniqueCities).sort();
        }
        
        // =========================================================================
        // 🔍 FUNÇÃO MELHORADA PARA VERIFICAR SE É UMA CIDADE REAL (NÃO NOME DE RÁDIO)
        // =========================================================================
        function isRealCity(cityName) {
            if (!cityName || typeof cityName !== 'string') return false;
            
            const lowerCityName = cityName.toLowerCase().trim();
            
            // ✅ FIX: Lista MUITO mais rigorosa de palavras que indicam rádio, não cidade
            const radioIndicators = [
                // Palavras óbvias de rádio/mídia
                'rádio', 'radio', 'fm', 'am', 'mhz', 'khz', 'dial',
                'emissora', 'transmissora', 'antena', 'torre', 'frequência', 'frequencia',
                'broadcasting', 'broadcast', 'stereo', 'mono', 'digital',
                
                // Gêneros musicais que aparecem em nomes de rádio
                'hits', 'mix', 'pop', 'rock', 'sertaneja', 'country', 'gospel',
                'jovem', 'teen', 'adult', 'contemporary', 'clássica', 'classica',
                'reggae', 'funk', 'rap', 'hip hop', 'eletrônica', 'eletronica',
                'bossa nova', 'samba', 'pagode', 'forró', 'forro', 'axé', 'axe',
                
                // Palavras comuns em nomes de rádio
                'news', 'notícias', 'noticias', 'jornalismo', 'informação', 'informacao',
                'música', 'musica', 'som', 'audio', 'sound', 'voice', 'voz',
                'show', 'programa', 'live', 'ao vivo', 'online', 'web', 'net',
                'cidade', 'capital', 'metropolitana', 'regional', 'nacional',
                'brasil', 'brazil', 'br', 'com', '.com', '.br', 'www',
                
                // Empresas e grupos de comunicação
                'comunicação', 'comunicacao', 'media', 'mídia', 'midia',
                'grupo', 'rede', 'sistema', 'canal', 'tv', 'televisão', 'televisao',
                'sat', 'satélite', 'satelite', 'cabo', 'digital',
                
                // Palavras técnicas
                'banda', 'ondas', 'hertz', 'watts', 'potência', 'potencia',
                'cobertura', 'alcance', 'sinal', 'transmissão', 'transmissao',
                
                // Indicadores de horário/programação
                'manhã', 'manha', 'tarde', 'noite', 'madrugada', '24h', '24 horas',
                'programação', 'programacao', 'playlist', 'top', 'best',
                
                // Palavras em inglês comuns em rádios
                'station', 'channel', 'network', 'group', 'media', 'entertainment',
                'music', 'news', 'talk', 'sports', 'culture', 'classic',
                
                // Sufixos/prefixos comuns de rádio
                'super', 'mega', 'ultra', 'maxi', 'mini', 'micro',
                'new', 'nova', 'novo', 'primeira', 'segunda', 'única', 'unica',
                'mais', 'melhor', 'grande', 'pequena', 'local', 'comunitária', 'comunitaria'
            ];
            
            // ✅ FIX: Verificação mais rigorosa
            for (const indicator of radioIndicators) {
                if (lowerCityName.includes(indicator)) {
                    return false;
                }
            }
            
            // ✅ FIX: Verificar padrões específicos de frequência
            if (/\d+[\.,]\d+/.test(cityName.trim())) { // ex: 107.3, 90,5
                return false;
            }
            
            // ✅ FIX: Verificar se é apenas números (frequência sem ponto)
            if (/^\d+$/.test(cityName.trim()) && cityName.trim().length <= 4) {
                return false;
            }
            
            // ✅ FIX: Verificar se começa com números (frequências)
            if (/^\d/.test(cityName.trim())) {
                return false;
            }
            
            // ✅ FIX: Verificar se contém @ ou URLs
            if (lowerCityName.includes('@') || lowerCityName.includes('http') || 
                lowerCityName.includes('www.') || lowerCityName.includes('.com') || 
                lowerCityName.includes('.br')) {
                return false;
            }
            
            // ✅ FIX: Muito curto (provavelmente siglas)
            if (cityName.trim().length < 3) {
                return false;
            }
            
            // ✅ FIX: Muito longo (provavelmente descrição de rádio)
            if (cityName.trim().length > 50) {
                return false;
            }
            
            // ✅ FIX: Contém muitos números (códigos ou frequências)
            const numberCount = (cityName.match(/\d/g) || []).length;
            if (numberCount > cityName.length / 3) { // Mais de 1/3 são números
                return false;
            }
            
            // ✅ FIX: Verificar padrões suspeitos
            if (cityName.includes('(') && cityName.includes(')') && !cityName.includes(' - ')) {
                // Parênteses sem formato "Cidade - UF" são suspeitos
                return false;
            }
            
            // ✅ FIX: Verificar se contém apenas caracteres especiais estranhos
            if (/^[^a-zA-ZÀ-ÿ\s\-]+$/.test(cityName)) {
                return false;
            }
            
            // Se chegou até aqui, provavelmente é uma cidade
            return true;
        }
        
        // =========================================================================
        // 🏙️ FUNÇÃO PARA CONTAR APENAS CIDADES REAIS (SEM RÁDIOS)
        // =========================================================================
        function countUniqueCities() {
            if (isPropostaMode) {
                // ✅ FIX: Modo proposta - contar apenas cidades das rádios ativas
                const uniqueCities = new Set();
                
                activeRadios.forEach((radio, index) => {
                    if (radio.active && radioData.radios[index]) {
                        const cities = radioData.radios[index].cidades || [];
                        cities.forEach(cidade => {
                            if (isRealCity(cidade)) {
                                // Usar apenas o nome da cidade sem UF para evitar duplicatas
                                const cityName = cidade.split(' - ')[0];
                                uniqueCities.add(cityName);
                            }
                        });
                    }
                });
                
                return uniqueCities.size;
            } else {
                // Modo individual
                if (!radioData.cidades) return 0;
                
                const uniqueCities = new Set();
                
                radioData.cidades.forEach(cidade => {
                    if (isRealCity(cidade)) {
                        // Usar apenas o nome da cidade sem UF para evitar duplicatas
                        const cityName = cidade.split(' - ')[0];
                        uniqueCities.add(cityName);
                    }
                });
                
                return uniqueCities.size;
            }
        }
        
        // Função auxiliar para calcular distância entre coordenadas (Haversine)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Raio da Terra em km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c; // Distância em km
        }
        
        // =========================================================================
        // 🚀 INICIALIZAÇÃO E-MÍDIAS
        // =========================================================================
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await loadRadioData();
                
                // Detectar modo (individual vs proposta)
                isPropostaMode = radioData.type === 'proposta';
                
                if (isPropostaMode) {
                    await initializePropostaMode();
                } else {
                    await initializeIndividualMode();
                }
                
                hideLoading();
            } catch (error) {
                console.error('Erro completo:', error);
                showError(error.message, error.stack);
            }
        });
        
        // =========================================================================
        // 📡 CARREGAR DADOS DO NOTION E-MÍDIAS
        // =========================================================================
        async function loadRadioData() {
            const params = new URLSearchParams(window.location.search);
            const notionId = params.get('id');
            const propostaId = params.get('proposta') || params.get('database');
            
            if (propostaId && /^[0-9a-f]{32}$/i.test(propostaId)) {
                try {
                    radioData = await fetchPropostaFromNotion(propostaId);
                } catch (error) {
                    throw new Error(`Erro ao carregar proposta: ${error.message}`);
                }
            } else if (notionId && /^[0-9a-f]{32}$/i.test(notionId)) {
                try {
                    radioData = await fetchRadioFromNotion(notionId);
                } catch (error) {
                    throw new Error(`Erro ao carregar dados: ${error.message}`);
                }
            } else {
                // Dados de exemplo para desenvolvimento/teste
                radioData = {
                    name: 'RÁDIO EXEMPLO FM',
                    dial: '107.3',
                    latitude: -27.0965,
                    longitude: -48.8438,
                    radius: 50000,
                    region: 'Sul',
                    uf: 'SC',
                    praca: 'Florianópolis',
                    universo: 1061390,
                    pmm: 12886,
                    imageUrl: 'https://via.placeholder.com/100x75/06055B/white?text=107.3',
                    coverageType: 'circle',
                    cidades: [
                        'Florianópolis - SC', 'São José - SC', 'Palhoça - SC', 'Biguaçu - SC',
                        'Blumenau - SC', 'Joinville - SC', 'Itajaí - SC'
                    ],
                    source: 'example',
                    type: 'individual'
                };
            }
        }
        
        // BUSCAR DADOS INDIVIDUAIS DO NOTION VIA NETLIFY FUNCTION
        async function fetchRadioFromNotion(notionId) {
            const response = await fetch(`/.netlify/functions/radio-data?id=${notionId}`);
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ error: 'Erro desconhecido' }));
                throw new Error(errorData.error || `Erro HTTP ${response.status}`);
            }
            
            const data = await response.json();
            return data;
        }
        
        // NOVA: BUSCAR DADOS DE PROPOSTA DO NOTION VIA NETLIFY FUNCTION
        async function fetchPropostaFromNotion(databaseId) {
            console.log('🔍 Buscando proposta:', databaseId);
            
            const response = await fetch(`/.netlify/functions/radio-data?proposta=${databaseId}`);
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ error: 'Erro desconhecido' }));
                throw new Error(errorData.error || `Erro HTTP ${response.status}`);
            }
            
            const data = await response.json();
            console.log('📡 Dados recebidos da API:', data);
            
            // Verificar estrutura dos dados
            if (data.type !== 'proposta') {
                console.warn('⚠️ Tipo de dados inesperado:', data.type);
            }
            
            if (!data.radios || data.radios.length === 0) {
                console.warn('⚠️ Nenhuma rádio encontrada nos dados');
            } else {
                console.log('📻 Rádios encontradas:', data.radios.length);
                data.radios.forEach((radio, i) => {
                    console.log(`📻 Rádio ${i + 1}:`, {
                        name: radio.name,
                        dial: radio.dial,
                        coords: [radio.latitude, radio.longitude],
                        notionId: radio.notionId
                    });
                });
            }
            
            return data;
        }
        
        // =========================================================================
        // 🎯 MODO INDIVIDUAL (ORIGINAL)
        // =========================================================================
        async function initializeIndividualMode() {
            console.log('🔍 Modo Individual ativado');
            renderInfoIndividual();
            await initializeMapIndividual();
            renderCidadesIndividual();
        }
        
        async function initializeMapIndividual() {
            return new Promise((resolve, reject) => {
                setTimeout(() => {
                    try {
                        if (typeof L === 'undefined') {
                            throw new Error('Leaflet não foi carregado corretamente');
                        }
                        
                        const mapElement = document.getElementById('map');
                        if (!mapElement) {
                            throw new Error('Elemento do mapa não encontrado');
                        }
                        
                        map = L.map('map');
                        
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: '© OpenStreetMap contributors',
                            maxZoom: 18
                        }).addTo(map);
                        
                        setTimeout(() => {
                            map.invalidateSize();
                        }, 100);
                        
                        addRadioMarkerIndividual();
                        addCoverageIndividual();
                        fitMapToCoverageIndividual();
                        
                        resolve();
                        
                    } catch (error) {
                        console.error('Erro detalhado do mapa:', error);
                        reject(error);
                    }
                }, 50);
            });
        }
        
        function addRadioMarkerIndividual() {
            const radioIcon = L.divIcon({
                html: `
                    <img src="${radioData.imageUrl}" 
                         alt="${radioData.name}" 
                         class="radio-marker-image"
                         onerror="this.src='https://via.placeholder.com/56x56/06055B/white?text=${encodeURIComponent(radioData.dial || 'FM')}'">
                `,
                className: 'radio-marker',
                iconSize: [56, 56],
                iconAnchor: [28, 28]
            });
            
            const popupContent = `
                <div class="radio-popup">
                    <img src="${radioData.imageUrl}" 
                         alt="${radioData.name}" 
                         onerror="this.src='https://via.placeholder.com/90x68/06055B/white?text=${encodeURIComponent(radioData.dial || 'FM')}'"
                    >
                    <h3>${radioData.name}</h3>
                    <p><strong>${radioData.dial}</strong></p>
                    <p>${radioData.praca} - ${radioData.uf}</p>
                </div>
            `;
            
            const radioMarker = L.marker([radioData.latitude, radioData.longitude], { icon: radioIcon })
                .bindPopup(popupContent)
                .addTo(map);
                
            radioMarkers.push(radioMarker);
        }
        
        function addCoverageIndividual() {
            if (radioData.coverageType === 'kml' && radioData.kmlCoordinates && radioData.kmlCoordinates.length > 0) {
                addKMLPolygonsIndividual();
            } else {
                addCoverageCircleIndividual();
            }
            
            if (radioData.kmlPlacemarks && radioData.kmlPlacemarks.length > 0) {
                addCityMarkersIndividual();
            }
        }
        
        function addKMLPolygonsIndividual() {
            const kmlGroup = L.layerGroup();
            
            for (const polygon of radioData.kmlCoordinates) {
                if (polygon.length > 2) {
                    const leafletPolygon = L.polygon(polygon, {
                        color: '#06055B',
                        fillColor: '#06055B',
                        fillOpacity: 0.15,
                        weight: 2,
                        opacity: 0.8
                    });
                    
                    leafletPolygon.bindPopup(`
                        <div style="text-align: center; font-family: var(--font-primary);">
                            <h4 style="color: #06055B; margin: 0 0 8px 0;">Projeção de Cobertura</h4>
                            <p style="margin: 0; color: #64748B; font-size: 13px;">Área calculada via KML</p>
                        </div>
                    `);
                    
                    kmlGroup.addLayer(leafletPolygon);
                }
            }
            
            const coverageLayer = kmlGroup;
            coverageLayer.addTo(map);
            coverageLayers.push(coverageLayer);
        }
        
        function addCoverageCircleIndividual() {
            const coverageLayer = L.circle([radioData.latitude, radioData.longitude], {
                color: '#06055B',
                fillColor: '#06055B',
                fillOpacity: 0.1,
                radius: radioData.radius,
                weight: 2
            });
            
            coverageLayer.bindPopup(`
                <div style="text-align: center; font-family: var(--font-primary);">
                    <h4 style="color: #06055B; margin: 0 0 8px 0;">Projeção de Cobertura</h4>
                    <p style="margin: 0; color: #64748B;">Raio: <strong>${(radioData.radius / 1000).toFixed(0)} km</strong></p>
                </div>
            `);
            
            coverageLayer.addTo(map);
            coverageLayers.push(coverageLayer);
        }
        
        function addCityMarkersIndividual() {
            cityMarkers.forEach(marker => map.removeLayer(marker));
            cityMarkers = [];
            
            window.cityPlacemarkMap = {};
            
            const cityIcon = L.divIcon({
                html: `
                    <div style="
                        width: 18px; 
                        height: 18px; 
                        background: #06055B; 
                        border-radius: 50%; 
                        border: 2px solid white;
                        box-shadow: 0 2px 6px rgba(6, 5, 91, 0.3);
                    "></div>
                `,
                className: 'city-marker',
                iconSize: [18, 18],
                iconAnchor: [9, 9]
            });
            
            const radioLocation = radioData.praca ? radioData.praca.toLowerCase() : '';
            const radioName = radioData.name ? radioData.name.toLowerCase() : '';
            
            radioData.kmlPlacemarks.forEach((placemark, index) => {
                const cityName = placemark.name.toLowerCase();
                
                if (
                    cityName.includes(radioLocation) || 
                    placemark.description?.includes('0.0 km') ||
                    placemark.description?.includes('0,0 km') ||
                    cityName === radioLocation ||
                    cityName.includes('origem') ||
                    cityName.includes(radioName.replace('rádio', '').replace('fm', '').trim()) ||
                    radioName.includes(cityName) ||
                    (placemark.description && placemark.description.match(/0\.[0-9]\s*km/))
                ) {
                    return;
                }
                
                const [lat, lng] = placemark.coordinates;
                
                const distanceFromRadio = calculateDistance(
                    radioData.latitude, radioData.longitude,
                    lat, lng
                );
                
                if (distanceFromRadio < 0.5) {
                    return;
                }
                
                const cityMarker = L.marker([lat, lng], { icon: cityIcon })
                    .bindPopup(`
                        <div style="text-align: center; min-width: 160px; font-family: var(--font-primary);">
                            <h4 style="margin: 0 0 8px 0; color: #06055B; font-weight: 600;">${placemark.name}</h4>
                            ${placemark.description ? `<p style="margin: 4px 0; font-size: 12px; color: #64748B;">${placemark.description}</p>` : ''}
                            <p style="margin: 4px 0; font-size: 11px; color: #9CA3AF;">
                                📍 ${lat.toFixed(4)}, ${lng.toFixed(4)}
                            </p>
                        </div>
                    `)
                    .addTo(map);
                    
                const markerIndex = cityMarkers.length;
                cityMarkers.push(cityMarker);
                window.cityPlacemarkMap[placemark.name.toLowerCase()] = {
                    markerIndex: markerIndex,
                    coordinates: [lat, lng],
                    placemark: placemark
                };
            });
        }
        
        function fitMapToCoverageIndividual() {
            if (radioData.coverageType === 'kml' && radioData.kmlBounds) {
                const bounds = L.latLngBounds(
                    [radioData.kmlBounds.south, radioData.kmlBounds.west],
                    [radioData.kmlBounds.north, radioData.kmlBounds.east]
                );
                map.fitBounds(bounds, { padding: [50, 50] });
            } else if (coverageLayers.length > 0 && coverageLayers[0].getBounds) {
                map.fitBounds(coverageLayers[0].getBounds(), { padding: [80, 80] });
            } else {
                const radiusKm = radioData.radius / 1000;
                let zoom = 5;
                
                if (radiusKm > 300) zoom = 3;
                else if (radiusKm > 200) zoom = 4;
                else if (radiusKm > 150) zoom = 4;
                else if (radiusKm > 100) zoom = 5;
                else if (radiusKm > 75) zoom = 5;
                else if (radiusKm > 50) zoom = 6;
                else if (radiusKm > 25) zoom = 7;
                else zoom = 8;
                
                map.setView([radioData.latitude, radioData.longitude], zoom);
            }
        }
        
        function renderInfoIndividual() {
            const container = document.getElementById('info-section');
            
            const pmmFormatted = radioData.pmm ? radioData.pmm.toLocaleString() : 'N/A';
            const universoFormatted = radioData.universo ? radioData.universo.toLocaleString() : 'N/A';
            
            container.innerHTML = `
                <!-- TÉCNICAS -->
                <div class="info-card">
                    <h3 class="card-title">📻 Informações Técnicas</h3>
                    <div class="info-item">
                        <span class="info-label">Dial:</span>
                        <span class="info-value">${radioData.dial}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Praça:</span>
                        <span class="info-value">${radioData.praca} - ${radioData.uf}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Região:</span>
                        <span class="info-value">${radioData.region}</span>
                    </div>
                </div>
                
                <!-- ALCANCE -->
                <div class="info-card">
                    <h3 class="card-title">🌐 Alcance e Cobertura</h3>
                    <div class="info-item">
                        <span class="info-label">PMM:</span>
                        <span class="info-value">${pmmFormatted}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Universo:</span>
                        <span class="info-value">${universoFormatted}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Cidades:</span>
                        <span class="info-value">${radioData.cidades ? radioData.cidades.length : 0}</span>
                    </div>
                </div>
            `;
            
            container.style.display = 'grid';
        }
        
        function renderCidadesIndividual() {
            allCities = (radioData.cidades || []).filter(cidade => {
                return isRealCity(cidade);
            });
            
            filteredCities = [...allCities];
            
            updateCidadesList();
            setupCitySearch();
            
            // Atualizar contador
            document.getElementById('cidade-count').textContent = allCities.length;
            document.getElementById('cidades-section').style.display = 'block';
        }
        
        // =========================================================================
        // 🎯 MODO PROPOSTA (NOVO)
        // =========================================================================
        async function initializePropostaMode() {
            console.log('🏢 Modo Proposta ativado');
            
            // Validar dados básicos
            if (!radioData.radios || radioData.radios.length === 0) {
                throw new Error('Nenhuma rádio encontrada na proposta');
            }
            
            // Garantir que todos os rádios tenham propriedades necessárias
            radioData.radios = radioData.radios.map((radio, index) => ({
                name: radio.name || 'Rádio Desconhecida',
                dial: radio.dial || 'N/A',
                latitude: radio.latitude || -23.5505,
                longitude: radio.longitude || -46.6333,
                radius: radio.radius || 50000,
                region: radio.region || 'N/A',
                uf: radio.uf || 'N/A',
                praca: radio.praca || 'N/A',
                universo: radio.universo || 0,
                pmm: radio.pmm || 0,
                impactos: radio.impactos || radio.pmm || 0, // ✅ FIX: Garantir que impactos existe
                imageUrl: radio.imageUrl || `https://via.placeholder.com/56x56/06055B/white?text=${encodeURIComponent(radio.dial || 'FM')}`,
                coverageType: radio.coverageType || 'circle',
                kmlCoordinates: radio.kmlCoordinates || [],
                kmlPlacemarks: radio.kmlPlacemarks || [],
                kmlBounds: radio.kmlBounds || null,
                cidades: radio.cidades || [],
                notionId: radio.notionId || `radio-${index}`,
                ...radio
            }));
            
            console.log('📊 Rádios validadas:', radioData.radios.length);
            
            renderInfoProposta();
            await initializeMapProposta();
            renderCidadesProposta();
        }
        
        async function initializeMapProposta() {
            return new Promise((resolve, reject) => {
                setTimeout(() => {
                    try {
                        if (typeof L === 'undefined') {
                            throw new Error('Leaflet não foi carregado corretamente');
                        }
                        
                        const mapElement = document.getElementById('map');
                        if (!mapElement) {
                            throw new Error('Elemento do mapa não encontrado');
                        }
                        
                        map = L.map('map');
                        
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: '© OpenStreetMap contributors',
                            maxZoom: 18
                        }).addTo(map);
                        
                        setTimeout(() => {
                            map.invalidateSize();
                        }, 100);
                        
                        addMultipleRadios();
                        fitMapToMultipleCoverage();
                        
                        resolve();
                        
                    } catch (error) {
                        console.error('Erro detalhado do mapa proposta:', error);
                        reject(error);
                    }
                }, 50);
            });
        }
        
        function addMultipleRadios() {
            if (!radioData.radios || radioData.radios.length === 0) {
                console.warn('Nenhuma rádio encontrada na proposta');
                return;
            }
            
            // Agrupar rádios por proximidade geográfica para evitar sobreposição
            const radioGroups = groupRadiosByProximity(radioData.radios);
            
            // Ordenar rádios por cobertura (maior primeiro) para rendering em camadas corretas
            const sortedRadios = [...radioData.radios].sort((a, b) => {
                const radiusA = a.radius || 50000;
                const radiusB = b.radius || 50000;
                return radiusB - radiusA; // Maior primeiro (vai para baixo no mapa)
            });
            
            // Adicionar coberturas primeiro (maior embaixo)
            sortedRadios.forEach((radio, sortIndex) => {
                const originalIndex = radioData.radios.findIndex(r => r.notionId === radio.notionId);
                const colorIndex = originalIndex % RADIO_COLORS.length;
                const color = RADIO_COLORS[colorIndex];
                
                addCoverageProposta(radio, originalIndex, color);
            });
            
            // Adicionar marcadores com reposicionamento para evitar sobreposição
            radioData.radios.forEach((radio, index) => {
                const colorIndex = index % RADIO_COLORS.length;
                const color = RADIO_COLORS[colorIndex];
                
                // Calcular offset para evitar sobreposição
                const adjustedPosition = calculateRadioOffset(radio, index, radioData.radios);
                
                addRadioMarkerProposta(radio, index, color, adjustedPosition);
                
                // Adicionar marcadores de cidades (se houver KML)
                if (radio.kmlPlacemarks && radio.kmlPlacemarks.length > 0) {
                    addCityMarkersProposta(radio, index, color);
                }
            });
        }
        
        // =========================================================================
        // 📍 FUNÇÃO PARA CALCULAR OFFSET DE RÁDIOS (EVITAR SOBREPOSIÇÃO)
        // =========================================================================
        function calculateRadioOffset(currentRadio, currentIndex, allRadios) {
            const proximityThreshold = 0.005; // ~500 metros
            const offsetDistance = 0.003; // ~300 metros
            
            let adjustedLat = currentRadio.latitude;
            let adjustedLng = currentRadio.longitude;
            
            // Verificar se há outras rádios muito próximas
            const nearbyRadios = allRadios.filter((radio, index) => {
                if (index >= currentIndex) return false; // Só verificar rádios já processadas
                
                const distance = Math.sqrt(
                    Math.pow(radio.latitude - currentRadio.latitude, 2) + 
                    Math.pow(radio.longitude - currentRadio.longitude, 2)
                );
                
                return distance < proximityThreshold;
            });
            
            if (nearbyRadios.length > 0) {
                // Calcular offset baseado no índice para criar padrão circular
                const angle = (currentIndex % 8) * (Math.PI / 4); // 8 posições ao redor
                const radius = offsetDistance * (Math.floor(currentIndex / 8) + 1);
                
                adjustedLat += Math.sin(angle) * radius;
                adjustedLng += Math.cos(angle) * radius;
                
                console.log(`📍 Rádio ${currentIndex} reposicionada para evitar sobreposição:`, {
                    original: [currentRadio.latitude, currentRadio.longitude],
                    adjusted: [adjustedLat, adjustedLng],
                    nearbyCount: nearbyRadios.length
                });
            }
            
            return [adjustedLat, adjustedLng];
        }
        
        function groupRadiosByProximity(radios) {
            const groups = {};
            const proximityThreshold = 0.01; // ~1km
            
            radios.forEach((radio, index) => {
                const key = `${Math.round(radio.latitude / proximityThreshold)}_${Math.round(radio.longitude / proximityThreshold)}`;
                
                if (!groups[key]) {
                    groups[key] = [];
                }
                groups[key].push({ radio, index });
            });
            
            return groups;
        }
        
        function addRadioMarkerProposta(radio, index, color, adjustedPosition = null) {
            // Usar posição ajustada se fornecida, senão usar posição original
            const [lat, lng] = adjustedPosition || [radio.latitude, radio.longitude];
            
            const radioIcon = L.divIcon({
                html: `
                    <img src="${radio.imageUrl}" 
                         alt="${radio.name}" 
                         class="radio-marker-image proposta-${(index % 5) + 1}"
                         onerror="this.src='https://via.placeholder.com/56x56/${color.replace('#', '')}/white?text=${encodeURIComponent(radio.dial || 'FM')}'">
                `,
                className: 'radio-marker',
                iconSize: [56, 56],
                iconAnchor: [28, 28]
            });
            
            const popupContent = `
                <div class="radio-popup">
                    <img src="${radio.imageUrl}" 
                         alt="${radio.name}" 
                         onerror="this.src='https://via.placeholder.com/90x68/${color.replace('#', '')}/white?text=${encodeURIComponent(radio.dial || 'FM')}'"
                    >
                    <h3>${radio.name}</h3>
                    <p><strong>${radio.dial}</strong></p>
                    <p>${radio.praca} - ${radio.uf}</p>
                    <p style="font-size: 12px; color: ${color};">Rádio ${index + 1} de ${radioData.totalRadios}</p>
                </div>
            `;
            
            const radioMarker = L.marker([lat, lng], { icon: radioIcon })
                .bindPopup(popupContent)
                .addTo(map);
                
            radioMarkers.push(radioMarker);
        }
        
        function addCoverageProposta(radio, index, color) {
            if (radio.coverageType === 'kml' && radio.kmlCoordinates && radio.kmlCoordinates.length > 0) {
                // Cobertura KML
                const kmlGroup = L.layerGroup();
                
                for (const polygon of radio.kmlCoordinates) {
                    if (polygon.length > 2) {
                        const leafletPolygon = L.polygon(polygon, {
                            color: color,
                            fillColor: color,
                            fillOpacity: 0.1,
                            weight: 2,
                            opacity: 0.6
                        });
                        
                        leafletPolygon.bindPopup(`
                            <div style="text-align: center; font-family: var(--font-primary);">
                                <h4 style="color: ${color}; margin: 0 0 8px 0;">${radio.name}</h4>
                                <p style="margin: 0; color: #64748B; font-size: 13px;">Cobertura via KML</p>
                            </div>
                        `);
                        
                        kmlGroup.addLayer(leafletPolygon);
                    }
                }
                
                kmlGroup.addTo(map);
                coverageLayers.push(kmlGroup);
            } else {
                // Cobertura circular
                const coverageLayer = L.circle([radio.latitude, radio.longitude], {
                    color: color,
                    fillColor: color,
                    fillOpacity: 0.08,
                    radius: radio.radius,
                    weight: 2,
                    opacity: 0.6
                });
                
                coverageLayer.bindPopup(`
                    <div style="text-align: center; font-family: var(--font-primary);">
                        <h4 style="color: ${color}; margin: 0 0 8px 0;">${radio.name}</h4>
                        <p style="margin: 0; color: #64748B;">Raio: <strong>${(radio.radius / 1000).toFixed(0)} km</strong></p>
                    </div>
                `);
                
                coverageLayer.addTo(map);
                coverageLayers.push(coverageLayer);
            }
        }
        
        function addCityMarkersProposta(radio, radioIndex, color) {
            const cityIcon = L.divIcon({
                html: `
                    <div style="
                        width: 16px; 
                        height: 16px; 
                        background: ${color}; 
                        border-radius: 50%; 
                        border: 2px solid white;
                        box-shadow: 0 2px 6px rgba(0,0,0,0.3);
                    "></div>
                `,
                className: 'city-marker',
                iconSize: [16, 16],
                iconAnchor: [8, 8]
            });
            
            const radioLocation = radio.praca ? radio.praca.toLowerCase() : '';
            const radioName = radio.name ? radio.name.toLowerCase() : '';
            
            radio.kmlPlacemarks.forEach((placemark, index) => {
                const cityName = placemark.name.toLowerCase();
                
                // Filtros para evitar marcadores duplicados
                if (
                    cityName.includes(radioLocation) || 
                    placemark.description?.includes('0.0 km') ||
                    placemark.description?.includes('0,0 km') ||
                    cityName === radioLocation ||
                    cityName.includes('origem') ||
                    cityName.includes(radioName.replace('rádio', '').replace('fm', '').trim())
                ) {
                    return;
                }
                
                const [lat, lng] = placemark.coordinates;
                
                const distanceFromRadio = calculateDistance(
                    radio.latitude, radio.longitude,
                    lat, lng
                );
                
                if (distanceFromRadio < 0.5) {
                    return;
                }
                
                const cityMarker = L.marker([lat, lng], { icon: cityIcon })
                    .bindPopup(`
                        <div style="text-align: center; min-width: 160px; font-family: var(--font-primary);">
                            <h4 style="margin: 0 0 8px 0; color: ${color}; font-weight: 600;">${placemark.name}</h4>
                            <p style="margin: 4px 0; font-size: 12px; color: #64748B;">Cobertura de: ${radio.name}</p>
                            ${placemark.description ? `<p style="margin: 4px 0; font-size: 12px; color: #64748B;">${placemark.description}</p>` : ''}
                            <p style="margin: 4px 0; font-size: 11px; color: #9CA3AF;">
                                📍 ${lat.toFixed(4)}, ${lng.toFixed(4)}
                            </p>
                        </div>
                    `)
                    .addTo(map);
                    
                cityMarkers.push(cityMarker);
            });
        }
        
        function fitMapToMultipleCoverage() {
            if (radioMarkers.length === 0) {
                console.warn('Nenhum marcador de rádio para ajustar o zoom');
                return;
            }
            
            try {
                // Criar grupo com todos os marcadores e coberturas
                const allLayers = [...radioMarkers, ...coverageLayers, ...cityMarkers];
                
                if (allLayers.length === 0) {
                    console.warn('Nenhuma camada para ajustar o zoom');
                    return;
                }
                
                // Calcular bounds manualmente se necessário
                let bounds = L.latLngBounds();
                let boundsCreated = false;
                
                // Adicionar coordenadas dos marcadores de rádio
                radioData.radios.forEach(radio => {
                    if (radio.latitude && radio.longitude) {
                        bounds.extend([radio.latitude, radio.longitude]);
                        boundsCreated = true;
                    }
                });
                
                // Adicionar bounds das coberturas KML
                radioData.radios.forEach(radio => {
                    if (radio.kmlBounds) {
                        bounds.extend([radio.kmlBounds.south, radio.kmlBounds.west]);
                        bounds.extend([radio.kmlBounds.north, radio.kmlBounds.east]);
                        boundsCreated = true;
                    }
                });
                
                if (boundsCreated) {
                    map.fitBounds(bounds, { padding: [50, 50] });
                } else {
                    // Fallback: centralizar na primeira rádio
                    const firstRadio = radioData.radios[0];
                    map.setView([firstRadio.latitude, firstRadio.longitude], 8);
                }
                
            } catch (error) {
                console.error('Erro ao ajustar zoom da proposta:', error);
                // Fallback: centralizar na primeira rádio
                const firstRadio = radioData.radios[0];
                map.setView([firstRadio.latitude, firstRadio.longitude], 8);
            }
        }
        
        function renderInfoProposta() {
            const container = document.getElementById('info-section');
            container.className = 'info-grid proposta'; // Adicionar classe especial
            
            // ✅ FIX: Calcular Impactos totais usando campo correto (radio.impactos ao invés de radio.pmm)
            const totalImpactos = radioData.radios.reduce((sum, radio) => {
                return sum + (radio.impactos || 0); // Usar sempre impactos
            }, 0);
            
            // Calcular universo único por cidade
            const universosPorCidade = {};
            radioData.radios.forEach(radio => {
                const cidade = radio.praca;
                if (cidade) {
                    if (!universosPorCidade[cidade] || radio.universo > universosPorCidade[cidade]) {
                        universosPorCidade[cidade] = radio.universo || 0;
                    }
                }
            });
            const universoUnicoTotal = Object.values(universosPorCidade).reduce((sum, val) => sum + val, 0);
            
            const totalImpactosFormatted = totalImpactos ? totalImpactos.toLocaleString() : 'N/A';
            const universoUnicoFormatted = universoUnicoTotal ? universoUnicoTotal.toLocaleString() : 'N/A';
            
            // ✅ FIX: Contar apenas cidades reais (usar função específica para proposta)
            const totalCidadesReais = countUniqueCities();
            
            // Inicializar array de rádios ativas (todas marcadas por padrão)
            activeRadios = radioData.radios.map((radio, index) => ({
                ...radio,
                index: index,
                active: true
            }));
            
            // Lista de rádios para o card com checkboxes
            const radiosListHtml = radioData.radios.map((radio, index) => `
                <div class="radio-item" id="radio-item-${index}">
                    <img src="${radio.imageUrl}" 
                         alt="${radio.name}"
                         onerror="this.src='https://via.placeholder.com/36x27/${RADIO_COLORS[index % RADIO_COLORS.length].replace('#', '')}/white?text=FM'">
                    <div class="radio-item-info" onclick="focusOnRadio(${index})">
                        <div class="radio-item-name">${radio.name}</div>
                        <div class="radio-item-details">${radio.dial} • ${radio.praca} - ${radio.uf}</div>
                    </div>
                    <input type="checkbox" 
                           class="radio-item-checkbox" 
                           id="checkbox-${index}"
                           checked 
                           onchange="toggleRadio(${index})">
                </div>
            `).join('');
            
            container.innerHTML = `
                <!-- ALCANCE TOTAL -->
                <div class="info-card">
                    <h3 class="card-title">🌐 Alcance Total</h3>
                    <div class="info-item">
                        <span class="info-label">Impactos Totais:</span>
                        <span class="info-value">${totalImpactosFormatted}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Universo Único:</span>
                        <span class="info-value">${universoUnicoFormatted}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Cidades Únicas:</span>
                        <span class="info-value">${totalCidadesReais}</span>
                    </div>
                </div>
                
                <!-- LISTA DE RÁDIOS -->
                <div class="info-card" style="position: relative;">
                    <h3 class="card-title">📻 Rádios do Plano</h3>
                    <span class="radio-count-badge" id="radio-count-badge">${radioData.totalRadios}</span>
                    <div class="radios-list">
                        ${radiosListHtml}
                    </div>
                </div>
            `;
            
            container.style.display = 'grid';
        }
        
        function renderCidadesProposta() {
            // Usar apenas cidades únicas (filtrar nomes de rádios)
            const allRealCities = new Set();
            
            // Coletar cidades de todas as rádios, filtrando nomes de rádios
            radioData.radios.forEach(radio => {
                const cities = radio.cidades || [];
                cities.forEach(cidade => {
                    if (isRealCity(cidade)) {
                        allRealCities.add(cidade);
                    }
                });
            });
            
            allCities = Array.from(allRealCities).sort();
            filteredCities = [...allCities];
            
            // CONSTRUIR MAPEAMENTO CIDADE -> RÁDIOS (apenas para cidades reais)
            buildCityRadioMapping();
            
            updateCidadesList();
            setupCitySearch();
            
            // Atualizar contador
            document.getElementById('cidade-count').textContent = allCities.length;
            document.getElementById('cidades-section').style.display = 'block';
        }
        
        // =========================================================================
        // 🗺️ CONSTRUIR MAPEAMENTO CIDADE -> RÁDIOS (MODO PROPOSTA)
        // =========================================================================
        function buildCityRadioMapping() {
            cityRadioMapping = {};
            
            if (!radioData.radios) return;
            
            // Para cada rádio, adicionar suas cidades ao mapeamento
            radioData.radios.forEach((radio, originalIndex) => {
                const cities = radio.cidades || [];
                
                cities.forEach(cidade => {
                    // Filtrar apenas cidades reais (não nomes de rádios)
                    if (!isRealCity(cidade)) return;
                    
                    const cityName = cidade.split(' - ')[0]; // Remover UF para o nome base
                    
                    if (!cityRadioMapping[cityName]) {
                        cityRadioMapping[cityName] = [];
                    }
                    
                    // Adicionar rádio com índice original para cores
                    cityRadioMapping[cityName].push({
                        ...radio,
                        originalIndex: originalIndex
                    });
                });
            });
            
            console.log('🗺️ Mapeamento cidade->rádios construído:', Object.keys(cityRadioMapping).length, 'cidades');
        }
        
        // =========================================================================
        // 🎯 FUNÇÕES AUXILIARES PARA PROPOSTA
        // =========================================================================
        function focusOnRadio(radioIndex) {
            if (!radioData.radios || radioIndex >= radioData.radios.length) {
                return;
            }
            
            const radio = radioData.radios[radioIndex];
            
            // Centralizar no mapa
            map.setView([radio.latitude, radio.longitude], 10);
            
            // Abrir popup do marcador
            if (radioMarkers[radioIndex]) {
                radioMarkers[radioIndex].openPopup();
            }
        }
        
        // =========================================================================
        // 🔘 FUNÇÃO PARA TOGGLE DE RÁDIOS (CHECKBOXES)
        // =========================================================================
        function toggleRadio(radioIndex) {
            if (!radioData.radios || radioIndex >= radioData.radios.length) {
                return;
            }
            
            const checkbox = document.getElementById(`checkbox-${radioIndex}`);
            const radioItem = document.getElementById(`radio-item-${radioIndex}`);
            
            if (!checkbox || !radioItem) {
                return;
            }
            
            const isActive = checkbox.checked;
            
            // Atualizar array de rádios ativas
            activeRadios[radioIndex].active = isActive;
            
            // Atualizar visual do item
            if (isActive) {
                radioItem.classList.remove('disabled');
            } else {
                radioItem.classList.add('disabled');
            }
            
            // Atualizar mapa
            updateMapLayers();
            
            // Atualizar contador
            updateRadioCount();
            
            console.log(`📻 Rádio ${radioIndex} (${radioData.radios[radioIndex].name}): ${isActive ? 'Ativada' : 'Desativada'}`);
        }
        
        // =========================================================================
        // 🗺️ ATUALIZAR CAMADAS DO MAPA (PROPOSTA)
        // =========================================================================
        function updateMapLayers() {
            if (!isPropostaMode) return;
            
            // Mostrar/ocultar marcadores de rádio
            radioMarkers.forEach((marker, index) => {
                if (activeRadios[index] && activeRadios[index].active) {
                    if (!map.hasLayer(marker)) {
                        map.addLayer(marker);
                    }
                } else {
                    if (map.hasLayer(marker)) {
                        map.removeLayer(marker);
                    }
                }
            });
            
            // Mostrar/ocultar camadas de cobertura
            coverageLayers.forEach((layer, index) => {
                if (activeRadios[index] && activeRadios[index].active) {
                    if (!map.hasLayer(layer)) {
                        map.addLayer(layer);
                    }
                } else {
                    if (map.hasLayer(layer)) {
                        map.removeLayer(layer);
                    }
                }
            });
            
            // Atualizar lista de cidades (mostrar apenas cidades das rádios ativas)
            updateCitiesForActiveRadios();
        }
        
        // =========================================================================
        // 🏙️ ATUALIZAR CIDADES PARA RÁDIOS ATIVAS
        // =========================================================================
        function updateCitiesForActiveRadios() {
            const activeCities = new Set();
            
            // Coletar cidades de todas as rádios ativas
            activeRadios.forEach((radio, index) => {
                if (radio.active && radioData.radios[index]) {
                    const cities = radioData.radios[index].cidades || [];
                    cities.forEach(cidade => {
                        // Filtrar apenas cidades reais
                        if (isRealCity(cidade)) {
                            activeCities.add(cidade);
                        }
                    });
                }
            });
            
            // Atualizar lista filtrada
            allCities = Array.from(activeCities).sort();
            filteredCities = [...allCities];
            
            // Reconstruir mapeamento apenas para rádios ativas
            buildCityRadioMappingForActiveRadios();
            
            // Atualizar visual
            updateCidadesList();
            document.getElementById('cidade-count').textContent = allCities.length;
        }
        
        // =========================================================================
        // 🗺️ MAPEAMENTO APENAS PARA RÁDIOS ATIVAS
        // =========================================================================
        function buildCityRadioMappingForActiveRadios() {
            cityRadioMapping = {};
            
            activeRadios.forEach((radio, index) => {
                if (!radio.active || !radioData.radios[index]) return;
                
                const radioData_single = radioData.radios[index];
                const cities = radioData_single.cidades || [];
                
                cities.forEach(cidade => {
                    // Filtrar apenas cidades reais
                    if (!isRealCity(cidade)) return;
                    
                    const cityName = cidade.split(' - ')[0];
                    
                    if (!cityRadioMapping[cityName]) {
                        cityRadioMapping[cityName] = [];
                    }
                    
                    cityRadioMapping[cityName].push({
                        ...radioData_single,
                        originalIndex: index
                    });
                });
            });
        }
        
        // =========================================================================
        // 📊 ATUALIZAR CONTADOR DE RÁDIOS ATIVAS
        // =========================================================================
        function updateRadioCount() {
            const activeCount = activeRadios.filter(radio => radio.active).length;
            const badge = document.getElementById('radio-count-badge');
            
            if (badge) {
                badge.textContent = `${activeCount}/${radioData.totalRadios}`;
                
                // Mudança visual baseada na quantidade ativa
                if (activeCount === 0) {
                    badge.style.background = 'var(--emidias-gray)';
                } else if (activeCount === radioData.totalRadios) {
                    badge.style.background = 'var(--gradient-accent)';
                } else {
                    badge.style.background = 'var(--gradient-primary)';
                }
            }
        }
        
        // =========================================================================
        // 🎨 FUNÇÕES COMUNS (USADAS POR AMBOS OS MODOS)
        // =========================================================================
        function updateCidadesList() {
            if (isPropostaMode) {
                updateCidadesListProposta();
                return;
            }
            
            // Modo individual (lógica original)
            const container = document.getElementById('cidades-list');
            
            if (filteredCities.length === 0) {
                container.innerHTML = '<div class="cidade-item">❌ Nenhuma cidade encontrada</div>';
                return;
            }
            
            container.innerHTML = filteredCities.map(cidade => {
                const parts = cidade.split(' - ');
                const nome = parts[0];
                const uf = parts[1] || radioData.uf;
                
                return `
                    <div class="cidade-item" onclick="highlightCity('${cidade}')">
                        <div class="cidade-info">
                            <span class="cidade-name">${nome}</span>
                            <span class="cidade-uf">${uf}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // =========================================================================
        // 🏢 FUNÇÃO PARA ATUALIZAR LISTA DE CIDADES NO MODO PROPOSTA
        // =========================================================================
        function updateCidadesListProposta() {
            const container = document.getElementById('cidades-list');
            
            if (filteredCities.length === 0) {
                container.innerHTML = '<div class="cidade-item">❌ Nenhuma cidade encontrada</div>';
                return;
            }
            
            container.innerHTML = filteredCities.map(cidade => {
                const parts = cidade.split(' - ');
                const nome = parts[0];
                const uf = parts[1] || '';
                
                // Buscar rádios que cobrem esta cidade
                const radiosQueCobrema = cityRadioMapping[nome] || [];
                
                // Gerar HTML das rádios
                let radiosHtml = '';
                if (radiosQueCobrema.length === 1) {
                    // Uma rádio: mostrar expandido
                    const radio = radiosQueCobrema[0];
                    radiosHtml = `
                        <div class="radio-expanded">
                            <img src="${radio.imageUrl}" 
                                 alt="${radio.name}"
                                 onerror="this.src='https://via.placeholder.com/36x27/${RADIO_COLORS[radio.originalIndex % RADIO_COLORS.length].replace('#', '')}/white?text=FM'">
                            <div class="radio-expanded-info">
                                <div class="radio-expanded-name">${radio.name}</div>
                                <div class="radio-expanded-details">${radio.dial} • ${radio.praca}</div>
                            </div>
                        </div>
                    `;
                } else if (radiosQueCobrema.length > 1) {
                    // ✅ FIX: Múltiplas rádios com hover estabilizado
                    radiosHtml = `
                        <div class="cidade-radios-container">
                            <div class="radios-collapsed">
                                ${radiosQueCobrema.slice(0, 3).map(radio => `
                                    <img class="radio-logo-mini" 
                                         src="${radio.imageUrl}" 
                                         alt="${radio.name}"
                                         title="${radio.name} ${radio.dial}"
                                         onerror="this.src='https://via.placeholder.com/36x27/${RADIO_COLORS[radio.originalIndex % RADIO_COLORS.length].replace('#', '')}/white?text=FM'">
                                `).join('')}
                                ${radiosQueCobrema.length > 3 ? `<span class="radio-count-extra">+${radiosQueCobrema.length - 3}</span>` : ''}
                            </div>
                            <div class="radios-expanded">
                                ${radiosQueCobrema.map(radio => `
                                    <div class="radio-expanded">
                                        <img src="${radio.imageUrl}" 
                                             alt="${radio.name}"
                                             onerror="this.src='https://via.placeholder.com/36x27/${RADIO_COLORS[radio.originalIndex % RADIO_COLORS.length].replace('#', '')}/white?text=FM'">
                                        <div class="radio-expanded-info">
                                            <div class="radio-expanded-name">${radio.name}</div>
                                            <div class="radio-expanded-details">${radio.dial} • ${radio.praca}</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }
                
                return `
                    <div class="cidade-item" onclick="highlightCity('${cidade}')">
                        <div class="cidade-info">
                            <span class="cidade-name">${nome}</span>
                            <span class="cidade-uf">${uf}</span>
                        </div>
                        <div class="cidade-radios">
                            ${radiosHtml}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function setupCitySearch() {
            const searchInput = document.getElementById('city-search');
            
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    const query = e.target.value.toLowerCase();
                    
                    filteredCities = allCities.filter(cidade => 
                        cidade.toLowerCase().includes(query)
                    );
                    
                    updateCidadesList();
                });
            }
        }
        
        function highlightCity(cityName) {
            const cityBaseName = cityName.split(' - ')[0].toLowerCase();
            
            // Modo individual: usar lógica original
            if (!isPropostaMode) {
                if (window.cityPlacemarkMap && window.cityPlacemarkMap[cityBaseName]) {
                    const cityData = window.cityPlacemarkMap[cityBaseName];
                    const [lat, lng] = cityData.coordinates;
                    
                    map.setView([lat, lng], 11);
                    
                    if (cityMarkers[cityData.markerIndex]) {
                        cityMarkers[cityData.markerIndex].openPopup();
                        return;
                    }
                }
                
                if (radioData.kmlPlacemarks && radioData.kmlPlacemarks.length > 0) {
                    for (let i = 0; i < radioData.kmlPlacemarks.length; i++) {
                        const placemark = radioData.kmlPlacemarks[i];
                        const placemarkName = placemark.name.toLowerCase();
                        
                        if (placemarkName.includes(cityBaseName) || cityBaseName.includes(placemarkName)) {
                            const mappedCity = window.cityPlacemarkMap[placemarkName];
                            if (mappedCity) {
                                const [lat, lng] = mappedCity.coordinates;
                                map.setView([lat, lng], 11);
                                
                                if (cityMarkers[mappedCity.markerIndex]) {
                                    cityMarkers[mappedCity.markerIndex].openPopup();
                                    return;
                                }
                            }
                        }
                    }
                }
                
                map.setView([radioData.latitude, radioData.longitude], 8);
            } else {
                // Modo proposta: tentar encontrar a cidade em qualquer rádio
                let cityFound = false;
                
                for (const radio of radioData.radios) {
                    if (radio.kmlPlacemarks && radio.kmlPlacemarks.length > 0) {
                        for (const placemark of radio.kmlPlacemarks) {
                            const placemarkName = placemark.name.toLowerCase();
                            
                            if (placemarkName.includes(cityBaseName) || cityBaseName.includes(placemarkName)) {
                                const [lat, lng] = placemark.coordinates;
                                map.setView([lat, lng], 11);
                                cityFound = true;
                                break;
                            }
                        }
                        if (cityFound) break;
                    }
                }
                
                // Se não encontrou, centralizar na primeira rádio
                if (!cityFound && radioData.radios.length > 0) {
                    const firstRadio = radioData.radios[0];
                    map.setView([firstRadio.latitude, firstRadio.longitude], 8);
                }
            }
        }
        
        function hideLoading() {
            const loadingElement = document.getElementById('loading');
            const infoElement = document.getElementById('info-section');
            const mapElement = document.getElementById('map-section');
            const radioNameElement = document.getElementById('radio-name');
            const radioInfoElement = document.getElementById('radio-info');
            
            if (loadingElement) loadingElement.style.display = 'none';
            if (infoElement) infoElement.style.display = 'grid';
            if (mapElement) mapElement.style.display = 'block';
            
            // Atualizar header baseado no modo
            if (isPropostaMode) {
                // Modo Proposta: usar logo E-MÍDIAS e título "Cobertura do Plano"
                const sourceSuffix = radioData.source === 'example' ? ' (EXEMPLO)' : '';
                if (radioNameElement) {
                    radioNameElement.innerHTML = `
                        <img class="header-logo" src="./assets/logo E-MIDIAS png fundo branco.png" alt="Logo E-MÍDIAS" 
                             onerror="this.src='./assets/logo E-MIDIAS png fundo branco HORIZONTAL.png'; this.onerror=function(){this.style.display='none'};">
                        Cobertura do Plano${sourceSuffix}
                        <span class="type-indicator type-proposta">Proposta</span>
                    `;
                }
                // ✅ FIX: Remover texto desnecessário do cabeçalho
                if (radioInfoElement) {
                    radioInfoElement.textContent = '';
                }
            } else {
                // Modo Individual: manter comportamento original
                const sourceSuffix = radioData.source === 'example' ? ' (EXEMPLO)' : '';
                if (radioNameElement) {
                    radioNameElement.innerHTML = `
                        <img class="header-logo" src="${radioData.imageUrl}" alt="Logo ${radioData.name}" 
                             onerror="this.style.display='none';">
                        ${radioData.name}${sourceSuffix}
                        <span class="type-indicator type-individual">Individual</span>
                    `;
                }
                // ✅ FIX: Manter apenas informações essenciais para modo individual
                if (radioInfoElement) radioInfoElement.textContent = `${radioData.dial} • ${radioData.praca} - ${radioData.uf}`;
            }
        }
        
        function showError(message, details = null) {
            const loadingElement = document.getElementById('loading');
            const errorElement = document.getElementById('error');
            const errorMessageElement = document.getElementById('error-message');
            const errorDetailsElement = document.getElementById('error-details');
            
            if (loadingElement) loadingElement.style.display = 'none';
            if (errorMessageElement) errorMessageElement.textContent = message;
            
            if (details && errorDetailsElement) {
                errorDetailsElement.textContent = details;
                errorDetailsElement.style.display = 'block';
            }
            
            if (errorElement) errorElement.style.display = 'block';
        }
    </script>
</body>
</html>
